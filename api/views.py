import asyncio
import random
from asgiref.sync import async_to_sync, sync_to_async
from telethon import TelegramClient
from telethon.errors import FloodWaitError
from telethon.tl.functions.contacts import ImportContactsRequest, DeleteContactsRequest
from telethon.tl.types import InputPhoneContact
from telethon.sessions import MemorySession

from rest_framework.viewsets import ModelViewSet
from rest_framework.response import Response
from rest_framework.decorators import api_view
from rest_framework.views import APIView

from api.models import TelegramUser
from api.utils import fernet
from api.serializers import TelegramUserSerializer

# Telegram API ma'lumotlari
api_id = 26106729
api_hash = 'bb13221ab81b637a7a8a23caec2af078'


class TelegramUserViewSet(ModelViewSet):
    queryset = TelegramUser.objects.all()
    serializer_class = TelegramUserSerializer

    def create(self, request, *args, **kwargs):
        phones = """998938052200    
998938052200    
998938052201    
998938052202    
998938052203    
998938052204    
998938052205    
998938052206    
998938052207    
998938052208    
998938052209    
998938052210    
998938052211    
998938052212    
998938052213    
998938052214    
998938052215    
998938052216    
998938052217    
998938052218    
998938052219    
998938052220    
998938052221    
998938052222    
998938052223    
998938052224    
998938052225    
998938052226    
998938052227    
998938052228    
998938052229    
998938052230    
998938052231    
998938052232    
998938052233    
998938052234    
998938052235    
998938052236    
998938052237    
998938052238    
998938052239    
998938052240    
998938052241    
998938052242    
998938052243    
998938052244    
998938052245    
998938052246    
998938052247    
998938052248    
998938052249    
998938052250    
998938052251    
998938052252    
998938052253    
998938052254    
998938052255    
998938052256    
998938052257    
998938052258    
998938052259    
998938052260    
998938052261    
998938052262    
998938052263    
998938052264    
998938052265    
998938052266    
998938052267    
998938052268    
998938052269    
998938052270    
998938052271    
998938052272    
998938052273    
998938052274    
998938052275    
998938052276    
998938052277    
998938052278    
998938052279    
998938052280    
998938052281    
998938052282    
998938052283    
998938052284    
998938052285    
998938052286    
998938052287    
998938052288    
998938052289    
998938052290    
998938052291    
998938052292    
998938052293    
998938052294    
998938052295    
998938052296    
998938052297    
998938052298    
998938052299    
998938052300    
998938052301    
998938052302    
998938052303    
998938052304    
998938052305    
998938052306    
998938052307    
998938052308    
998938052309    
998938052310    
998938052311    
998938052312    
998938052313    
998938052314    
998938052315    
998938052316    
998938052317    
998938052318    
998938052319    
998938052320    
998938052321    
998938052322    
998938052323    
998938052324    
998938052325    
998938052326    
998938052327    
998938052328    
998938052329    
998938052330    
998938052331    
998938052332    
998938052333    
998938052334    
998938052335    
998938052336    
998938052337    
998938052338    
998938052339    
998938052340    
998938052341    
998938052342    
998938052343    
998938052344    
998938052345    
998938052346    
998938052347    
998938052348    
998938052349    
998938052350    
998938052351    
998938052352    
998938052353    
998938052354    
998938052355    
998938052356    
998938052357    
998938052358    
998938052359    
998938052360    
998938052361    
998938052362    
998938052363    
998938052364    
998938052365    
998938052366    
998938052367    
998938052368    
998938052369    
998938052370    
998938052371    
998938052372    
998938052373    
998938052374    
998938052375    
998938052376    
998938052377    
998938052378    
998938052379    
998938052380    
998938052381    
998938052382    
998938052383    
998938052384    
998938052385    
998938052386    
998938052387    
998938052388    
998938052389    
998938052390    
998938052391    
998938052392    
998938052393    
998938052394    
998938052395    
998938052396    
998938052397    
998938052398    
998938052399    
998938052400    
998938052401    
998938052402    
998938052403    
998938052404    
998938052405    
998938052406    
998938052407    
998938052408    
998938052409    
998938052410    
998938052411    
998938052412    
998938052413    
998938052414    
998938052415    
998938052416    
998938052417    
998938052418    
998938052419    
998938052420    
998938052421    
998938052422    
998938052423    
998938052424    
998938052425    
998938052426    
998938052427    
998938052428    
998938052429    
998938052430    
998938052431    
998938052432    
998938052433    
998938052434    
998938052435    
998938052436    
998938052437    
998938052438    
998938052439    
998938052440    
998938052441    
998938052442    
998938052443    
998938052444    
998938052445    
998938052446    
998938052447    
998938052448    
998938052449    
998938052450    
998938052451    
998938052452    
998938052453    
998938052454    
998938052455    
998938052456    
998938052457    
998938052458    
998938052459    
998938052460    
998938052461    
998938052462    
998938052463    
998938052464    
998938052465    
998938052466    
998938052467    
998938052468    
998938052469    
998938052470    
998938052471    
998938052472    
998938052473    
998938052474    
998938052475    
998938052476    
998938052477    
998938052478    
998938052479    
998938052480    
998938052481    
998938052482    
998938052483    
998938052484    
998938052485    
998938052486    
998938052487    
998938052488    
998938052489    
998938052490    
998938052491    
998938052492    
998938052493    
998938052494    
998938052495    
998938052496    
998938052497    
998938052498    
998938052499    
998938052500    
998938052501    
998938052502    
998938052503    
998938052504    
998938052505    
998938052506    
998938052507    
998938052508    
998938052509    
998938052510    
998938052511    
998938052512    
998938052513    
998938052514    
998938052515    
998938052516    
998938052517    
998938052518    
998938052519    
998938052520    
998938052521    
998938052522    
998938052523    
998938052524    
998938052525    
998938052526    
998938052527    
998938052528    
998938052529    
998938052530    
998938052531    
998938052532    
998938052533    
998938052534    
998938052535    
998938052536    
998938052537    
998938052538    
998938052539    
998938052540    
998938052541    
998938052542    
998938052543    
998938052544    
998938052545    
998938052546    
998938052547    
998938052548    
998938052549    
998938052550    
998938052551    
998938052552    
998938052553    
998938052554    
998938052555    
998938052556    
998938052557    
998938052558    
998938052559    
998938052560    
998938052561    
998938052562    
998938052563    
998938052564    
998938052565    
998938052566    
998938052567    
998938052568    
998938052569    
998938052570    
998938052571    
998938052572    
998938052573    
998938052574    
998938052575    
998938052576    
998938052577    
998938052578    
998938052579    
998938052580    
998938052581    
998938052582    
998938052583    
998938052584    
998938052585    
998938052586    
998938052587    
998938052588    
998938052589    
998938052590    
998938052591    
998938052592    
998938052593    
998938052594    
998938052595    
998938052596    
998938052597    
998938052598    
998938052599    
998938052600    
998938052601    
998938052602    
998938052603    
998938052604    
998938052605    
998938052606    
998938052607    
998938052608    
998938052609    
998938052610    
998938052611    
998938052612    
998938052613    
998938052614    
998938052615    
998938052616    
998938052617    
998938052618    
998938052619    
998938052620    
998938052621    
998938052622    
998938052623    
998938052624    
998938052625    
998938052626    
998938052627    
998938052628    
998938052629    
998938052630    
998938052631    
998938052632    
998938052633    
998938052634    
998938052635    
998938052636    
998938052637    
998938052638    
998938052639    
998938052640    
998938052641    
998938052642    
998938052643    
998938052644    
998938052645    
998938052646    
998938052647    
998938052648    
998938052649    
998938052650    
998938052651    
998938052652    
998938052653    
998938052654    
998938052655    
998938052656    
998938052657    
998938052658    
998938052659    
998938052660    
998938052661    
998938052662    
998938052663    
998938052664    
998938052665    
998938052666    
998938052667    
998938052668    
998938052669    
998938052670    
998938052671    
998938052672    
998938052673    
998938052674    
998938052675    
998938052676    
998938052677    
998938052678    
998938052679    
998938052680    
998938052681    
998938052682    
998938052683    
998938052684    
998938052685    
998938052686    
998938052687    
998938052688    
998938052689    
998938052690    
998938052691    
998938052692    
998938052693    
998938052694    
998938052695    
998938052696    
998938052697    
998938052698    
998938052699    
998938052700    
998938052701    
998938052702    
998938052703    
998938052704    
998938052705    
998938052706    
998938052707    
998938052708    
998938052709    
998938052710    
998938052711    
998938052712    
998938052713    
998938052714    
998938052715    
998938052716    
998938052717    
998938052718    
998938052719    
998938052720    
998938052721    
998938052722    
998938052723    
998938052724    
998938052725    
998938052726    
998938052727    
998938052728    
998938052729    
998938052730    
998938052731    
998938052732    
998938052733    
998938052734    
998938052735    
998938052736    
998938052737    
998938052738    
998938052739    
998938052740    
998938052741    
998938052742    
998938052743    
998938052744    
998938052745    
998938052746    
998938052747    
998938052748    
998938052749    
998938052750    
998938052751    
998938052752    
998938052753    
998938052754    
998938052755    
998938052756    
998938052757    
998938052758    
998938052759    
998938052760    
998938052761    
998938052762    
998938052763    
998938052764    
998938052765    
998938052766    
998938052767    
998938052768    
998938052769    
998938052770    
998938052771    
998938052772    
998938052773    
998938052774    
998938052775    
998938052776    
998938052777    
998938052778    
998938052779    
998938052780    
998938052781    
998938052782    
998938052783    
998938052784    
998938052785    
998938052786    
998938052787    
998938052788    
998938052789    
998938052790    
998938052791    
998938052792    
998938052793    
998938052794    
998938052795    
998938052796    
998938052797    
998938052798    
998938052799    
998938052800    
998938052801    
998938052802    
998938052803    
998938052804    
998938052805    
998938052806    
998938052807    
998938052808    
998938052809    
998938052810    
998938052811    
998938052812    
998938052813    
998938052814    
998938052815    
998938052816    
998938052817    
998938052818    
998938052819    
998938052820    
998938052821    
998938052822    
998938052823    
998938052824    
998938052825    
998938052826    
998938052827    
998938052828    
998938052829    
998938052830    
998938052831    
998938052832    
998938052833    
998938052834    
998938052835    
998938052836    
998938052837    
998938052838    
998938052839    
998938052840    
998938052841    
998938052842    
998938052843    
998938052844    
998938052845    
998938052846    
998938052847    
998938052848    
998938052849    
998938052850    
998938052851    
998938052852    
998938052853    
998938052854    
998938052855    
998938052856    
998938052857    
998938052858    
998938052859    
998938052860    
998938052861    
998938052862    
998938052863    
998938052864    
998938052865    
998938052866    
998938052867    
998938052868    
998938052869    
998938052870    
998938052871    
998938052872    
998938052873    
998938052874    
998938052875    
998938052876    
998938052877    
998938052878    
998938052879    
998938052880    
998938052881    
998938052882    
998938052883    
998938052884    
998938052885    
998938052886    
998938052887    
998938052888    
998938052889    
998938052890    
998938052891    
998938052892    
998938052893    
998938052894    
998938052895    
998938052896    
998938052897    
998938052898    
998938052899    
998938052900    
998938052901    
998938052902    
998938052903    
998938052904    
998938052905    
998938052906    
998938052907    
998938052908    
998938052909    
998938052910    
998938052911    
998938052912    
998938052913    
998938052914    
998938052915    
998938052916    
998938052917    
998938052918    
998938052919    
998938052920    
998938052921    
998938052922    
998938052923    
998938052924    
998938052925    
998938052926    
998938052927    
998938052928    
998938052929    
998938052930    
998938052931    
998938052932    
998938052933    
998938052934    
998938052935    
998938052936    
998938052937    
998938052938    
998938052939    
998938052940    
998938052941    
998938052942    
998938052943    
998938052944    
998938052945    
998938052946    
998938052947    
998938052948    
998938052949    
998938052950    
998938052951    
998938052952    
998938052953    
998938052954    
998938052955    
998938052956    
998938052957    
998938052958    
998938052959    
998938052960    
998938052961    
998938052962    
998938052963    
998938052964    
998938052965    
998938052966    
998938052967    
998938052968    
998938052969    
998938052970    
998938052971    
998938052972    
998938052973    
998938052974    
998938052975    
998938052976    
998938052977    
998938052978    
998938052979    
998938052980    
998938052981    
998938052982    
998938052983    
998938052984    
998938052985    
998938052986    
998938052987    
998938052988    
998938052989    
998938052990    
998938052991    
998938052992    
998938052993    
998938052994    
998938052995    
998938052996    
998938052997    
998938052998    
998938052999    
998938053000    
998938053001    
998938053002    
998938053003    
998938053004    
998938053005    
998938053006    
998938053007    
998938053008    
998938053009    
998938053010    
998938053011    
998938053012    
998938053013    
998938053014    
998938053015    
998938053016    
998938053017    
998938053018    
998938053019    
998938053020    
998938053021    
998938053022    
998938053023    
998938053024    
998938053025    
998938053026    
998938053027    
998938053028    
998938053029    
998938053030    
998938053031    
998938053032    
998938053033    
998938053034    
998938053035    
998938053036    
998938053037    
998938053038    
998938053039    
998938053040    
998938053041    
998938053042    
998938053043    
998938053044    
998938053045    
998938053046    
998938053047    
998938053048    
998938053049    
998938053050    
998938053051    
998938053052    
998938053053    
998938053054    
998938053055    
998938053056    
998938053057    
998938053058    
998938053059    
998938053060    
998938053061    
998938053062    
998938053063    
998938053064    
998938053065    
998938053066    
998938053067    
998938053068    
998938053069    
998938053070    
998938053071    
998938053072    
998938053073    
998938053074    
998938053075    
998938053076    
998938053077    
998938053078    
998938053079    
998938053080    
998938053081    
998938053082    
998938053083    
998938053084    
998938053085    
998938053086    
998938053087    
998938053088    
998938053089    
998938053090    
998938053091    
998938053092    
998938053093    
998938053094    
998938053095    
998938053096    
998938053097    
998938053098    
998938053099    
998938053100    
998938053101    
998938053102    
998938053103    
998938053104    
998938053105    
998938053106    
998938053107    
998938053108    
998938053109    
998938053110    
998938053111    
998938053112    
998938053113    
998938053114    
998938053115    
998938053116    
998938053117    
998938053118    
998938053119    
998938053120    
998938053121    
998938053122    
998938053123    
998938053124    
998938053125    
998938053126    
998938053127    
998938053128    
998938053129    
998938053130    
998938053131    
998938053132    
998938053133    
998938053134    
998938053135    
998938053136    
998938053137    
998938053138    
998938053139    
998938053140    
998938053141    
998938053142    
998938053143    
998938053144    
998938053145    
998938053146    
998938053147    
998938053148    
998938053149    
998938053150    
998938053151    
998938053152    
998938053153    
998938053154    
998938053155    
998938053156    
998938053157    
998938053158    
998938053159    
998938053160    
998938053161    
998938053162    
998938053163    
998938053164    
998938053165    
998938053166    
998938053167    
998938053168    
998938053169    
998938053170    
998938053171    
998938053172    
998938053173    
998938053174    
998938053175    
998938053176    
998938053177    
998938053178    
998938053179    
998938053180    
998938053181    
998938053182    
998938053183    
998938053184    
998938053185    
998938053186    
998938053187    
998938053188    
998938053189    
998938053190    
998938053191    
998938053192    
998938053193    
998938053194    
998938053195    
998938053196    
998938053197    
998938053198    
998938053199    
"""
        phones_format = [p.strip() for p in phones.split() if p.strip()]
        phones_list = request.data.get("phones", phones_format)
        if not phones_list or not isinstance(phones_list, list):
            return Response({'error': 'Telefon raqamlar listda bo‘lishi kerak'}, status=400)

        @sync_to_async
        def save_user_to_db(user, phone):
            encrypted_phone = fernet.encrypt(phone.encode())

            all_users = TelegramUser.objects.all()
            for existing in all_users:
                try:
                    existing_phone = fernet.decrypt(existing.phone).decode()
                except Exception:
                    continue

                if existing.telegram_id == user.id and existing_phone == phone:
                    if (
                        existing.first_name == (user.first_name or '') and
                        existing.last_name == (user.last_name or '') and
                        existing.username == (user.username or '')
                    ):
                        return {
                            'telegram_id': user.id,
                            'phone': phone,
                            'first_name': user.first_name,
                            'last_name': user.last_name,
                            'username': user.username,
                            'saved': False,
                            'message': '❌ O‘xshash maʼlumot bor, saqlanmadi'
                        }

            new_user = TelegramUser.objects.create(
                telegram_id=user.id,
                phone=encrypted_phone,
                first_name=user.first_name or '',
                last_name=user.last_name or '',
                username=user.username or ''
            )
            return {
                'telegram_id': new_user.telegram_id,
                'phone': phone,
                'first_name': new_user.first_name,
                'last_name': new_user.last_name,
                'username': new_user.username,
                'saved': True,
                'message': '✅ Yangi yozuv saqlandi'
            }

        async def fetch_all_users():
            results = []
            async with TelegramClient(MemorySession(), api_id, api_hash) as client:
                await client.start()
                for phone in phones_list:
                    await asyncio.sleep(random.uniform(3, 7))
                    contact = InputPhoneContact(client_id=0, phone=phone, first_name="", last_name="")
                    try:
                        result = await client(ImportContactsRequest([contact]))
                    except FloodWaitError as e:
                        await asyncio.sleep(e.seconds)
                        continue

                    user = result.users[0] if result.users else None
                    if user:
                        await client(DeleteContactsRequest(id=[user]))
                        user_data = await save_user_to_db(user, phone)
                        results.append(user_data)
                    else:
                        results.append({
                            'phone': phone,
                            'error': 'Telegram foydalanuvchisi topilmadi'
                        })
            return results

        # MUHIM: asyncio.run bilan coroutine’ni sinxron ishlatamiz
        all_results = asyncio.run(fetch_all_users())
        return Response(all_results)


@api_view(['GET'])
def search_telegram_user(request):
    query = request.GET.get('id')
    if not query:
        return Response({'error': 'Query param id is required'}, status=400)

    users = TelegramUser.objects.filter(telegram_id__icontains=query)
    results = TelegramUserSerializer(users, many=True).data
    return Response(results)


class LatestUserDataView(APIView):
    def get(self, request):
        latest_data = TelegramUser.objects.latest('created_at')
        serializer = TelegramUserSerializer(latest_data)
        return Response(serializer.data)
